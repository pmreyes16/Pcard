# PCard User Management System

## Overview
The PCard application has been updated to remove public signup functionality and implement an admin-controlled user invitation system. Users can now only join the platform through unique invitation URLs generated by administrators.

## Key Changes

### 1. Removed Signup Functionality
- ✅ Deleted `SignupForm.tsx` component
- ✅ Updated `AuthPage.tsx` to only show login form
- ✅ Modified `LoginForm.tsx` to remove signup toggle and accept username instead of email
- ✅ Removed all references to signup in navigation and UI

### 2. Added Admin System
- ✅ Created `AdminPage.tsx` component for generating user invitations
- ✅ Added admin tab to the Dashboard (visible to admin users only)
- ✅ Simple admin detection based on email patterns (can be enhanced)

### 3. Invitation System
- ✅ Created `InvitePage.tsx` component for handling invitation URLs
- ✅ Added database schema for user invitations (`supabase-invitations.sql`)
- ✅ Implemented token-based invitation system with expiration
- ✅ Added routes for `/admin` and `/invite/:token`

## How It Works

### For Administrators
1. Admin users can access the Admin tab in the Dashboard
2. Generate invitations by providing:
   - Username for the new user
   - Password for the new user
3. System generates a unique invitation URL (e.g., `/invite/inv_abc123xyz`)
4. Share the URL and credentials with the new user

### For New Users
1. Receive invitation URL and credentials from admin
2. Visit the invitation URL
3. Review the pre-configured credentials
4. Click "Create My Account" to complete registration
5. Account is created and invitation is marked as used
6. Redirect to main page for login

### For Existing Users
1. Login using username and password (no more email)
2. Password reset functionality remains available
3. No access to signup - must use invitation system

## Database Schema

### New Table: `user_invitations`
```sql
- id: UUID (primary key)
- token: TEXT (unique invitation token)
- username: TEXT (predefined username)
- password: TEXT (predefined password)
- expires_at: TIMESTAMP (invitation expiration)
- used: BOOLEAN (whether invitation has been used)
- used_at: TIMESTAMP (when invitation was used)
- created_at: TIMESTAMP (when invitation was created)
- created_by: UUID (optional: admin who created it)
```

## Security Features
- Invitations expire after 7 days
- Tokens are unique and one-time use
- Row Level Security (RLS) policies protect invitation data
- Admin access is role-based (can be enhanced)

## Admin Access
Currently, admin access is determined by email patterns:
- Email contains "admin" OR
- Email is "admin@pcard.com"

This can be enhanced with:
- Database-stored admin roles
- More sophisticated permission systems
- Multi-level admin access

## Setup Instructions

### 1. Database Setup
Run the SQL script in your Supabase dashboard:
```bash
# Execute the contents of supabase-invitations.sql in Supabase SQL Editor
```

### 2. Admin User Creation
Create your first admin user manually in Supabase Auth:
1. Go to Supabase Dashboard > Authentication > Users
2. Create a new user with email like "admin@pcard.com"
3. This user will have admin access in the application

### 3. Environment Variables
No additional environment variables needed for basic functionality.

## API Endpoints Used
- `supabase.from('user_invitations').insert()` - Create invitation
- `supabase.from('user_invitations').select()` - Validate invitation
- `supabase.from('user_invitations').update()` - Mark as used
- `supabase.auth.signUp()` - Create user account
- `supabase.auth.signInWithPassword()` - User login

## Future Enhancements
1. **Enhanced Admin System**: Database-stored admin roles
2. **Bulk Invitations**: Generate multiple invitations at once
3. **Invitation Management**: View, edit, delete existing invitations
4. **User Management**: Admin can manage existing users
5. **Audit Logging**: Track admin actions and user registrations
6. **Email Integration**: Automatically send invitation emails
7. **Custom Expiration**: Allow admins to set custom expiration times
8. **Password Security**: Hash passwords in database instead of storing plain text

## Security Considerations
- **Password Storage**: Currently storing plain text passwords for simplicity. In production, implement proper password hashing.
- **Admin Detection**: Simple email-based admin detection should be enhanced with proper role management.
- **Token Security**: Tokens are currently generated client-side. Consider server-side generation for enhanced security.
- **Rate Limiting**: Consider adding rate limiting for invitation generation.

## Testing
1. Access `/admin` route as an admin user
2. Generate a test invitation
3. Use invitation URL in incognito/private browser
4. Verify account creation works
5. Test login with new credentials
6. Confirm invitation is marked as used